<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Инвентарь</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.9, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
	<link rel="stylesheet" href="../css/navigationMenu.css">
	<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="../css/rarity.css">
	<link rel="stylesheet" type="text/css" href="../css/main.css">
	<link rel="stylesheet" type="text/css" href="../css/inventory.css">
	<link rel="stylesheet" type="text/css" href="../css/fonts.css">
	<link rel="stylesheet" type="text/css" href="../css/loading.css">
	<link rel="stylesheet" type="text/css" href="../css/buttons.css">
	<link rel="stylesheet" href="../css/lobibox.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/winter.css">

	<script src="../scripts/build/libs.js"></script>
	<script src="../scripts/bootstrap.min.js"></script>
	<script src="../scripts/main.js"></script>
	<script src="../scripts/settings.js"></script>
	<script src="../scripts/cases2.js"></script>
	<script src="../scripts/weapons.js"></script>
	<script src="../scripts/skinNames.js"></script>
	<script src="../scripts/prices.js"></script>
	<script src="../scripts/quality.js"></script>
    <script src="https://www.promisejs.org/polyfills/promise-7.0.4.min.js"></script>

	<script src="../scripts/navigationMenu.js"></script>

	<script src="../scripts/localization.js"></script>
</head>

<body data-localization="inventory" data-inventory='no-load' data-ad='no'>
	<div class="site-overlay"></div>
	<div id="container">
	<div class="navigationBar" data-menu-EN="Inventory" data-menu-RU="Мой инвентарь" style="box-shadow: none !important;"></div>
	<div class="sort">
        <select class="form-control input-sm input-sort" id="sort-special"></select>
        <select class="form-control input-sm input-sort" id="sort-weapon"></select>
        <select class="form-control input-sm input-sort" id="sort-quality"></select>
	</div>
	<div class="inventoryList">
		<span id="intentory-Player"></span>
		<div class="closeInventory"></div>
		<ul class="inventory">
			<li id="js-loading-inventory" data-from="1">
				<div class="cssload-container">
					<div class="cssload-speeding-wheel"></div>
				</div>
			</li>
		</ul>
	</div>

	<div id="weaponInfoContainer" style="display: none" data-loc-group="weapon_info">
		<div class="glassBlur" style='width: 100%; height: 100%'></div>
		<div class="fullWeaponInfo">
			<span class="fullWeaponInfo-close">X</span>
			<span id="weaponName"></span>
			<div class="img_container">
                <img src="../images/stattrak.png" id="statTrakImg">
                <img src="" id="weaponImg">
                <button class="btn btn-primary lock" id='lock'>
                    <i class="fa fa-unlock" aria-hidden="true"></i>
                </button>
                <div id='weaponStickers'></div>
                <div id="weaponLoadingImg"><i class="fa fa-refresh fa-spin" aria-hidden="true"></i></div>
			</div>
			<div class='weapon-infoBlock'>
                <table id="weaponInfoTable">
                    <tr>
                        <td data-loc="price">Price</td>
                        <td id="weaponPrice" class='currency dollar'></td>
                    </tr>
                    <tr>
                        <td data-loc="quality">Quality</td>
                        <td id="weaponQuality"></td>
                    </tr>
                    <tr>
                        <td data-loc="phase">Phase</td>
                        <td id="weaponPhase"></td>
                    </tr>
                </table>
			</div>
			<button class='button_black' id='startContract' data-loc="trade_up_contract">Trade Up Contract</button>
			<button class='button_black' id='sellWeapon' data-loc="sell">Sell</button>
			<button class='button_black' data-loc="rename" data-toggle='modal' data-target='#rename-weapon-modal' data-loc-var='{"1": "1000<i class=\"double-icon\"></i>"}' id='rename_button'>Rename 1000<i class="double-icon"></i></button>
			<button class='button_black' data-loc="apply_sticker" id='apply_sticker'>Apply sticker</button>
			<button class='button_black' data-loc="apply_sticker_to_item" id='apply_sticker_to_item'>Apply sticker to this item</button>
			<span id='weaponRarity' style='display:none;'></span>
		</div>
	</div>
	
	<div class="stickerScratch" style="display:none;" data-loc-group='sticker_scratch'>
        <h5 class='text-black' data-loc='title'>Sticker Scratch</h5>
	    <canvas id='scratch' width="300" height="300"></canvas>
	    <button class="btn btn-success" id='remove_sticker_window' data-loc='remove'>Remove sticker</button>
	    <button class="btn btn-danger" id='calcel_remove_window' data-loc='cancel'>Cancel</button>
	    <button class="btn btn-empty text-bold pull-right" id='scratch_help'>?</button>
	</div>

	<div class='bottomBar' id='tradeBar' style='display: none' data-loc-group="trade_up_contract">
		<button class='btn btn-danger' id='cancelContract' data-loc="close">Close contract</button>
		<button class='btn btn-success' id='finishContract' data-loc="proceed">Proceed...</button>
	</div>
	
	<div class='bottomBar' id='selectBar' style='display: none' data-loc-group="select">
		<button class='btn btn-primary' id='sellSelected' data-loc="sell">Sell selected</button>
		<button class='btn btn-info' id='selectAll' data-loc="select">Select all</button>
		<button class='btn btn-info' id='unselect' data-loc="unselect">Unselect all</button>
	</div>
	
	<div class='bottomBar' id='applyStickerBar' style='display: none' data-loc-group="stickerBar">
		<span data-loc='descr'>Choose a Weapon to use with your Sticker</span><br>
		<button class='btn btn-danger' id='cancelSticker' data-loc="cancel">Cancel</button>
	</div>
</div>
	<div class="statistic" data-loc-group="statistic">
		<span class="stat"><span data-loc="worth">Worth:</span> <span id="stat-sum" class='currency dollar'>0</span></span>
		<span class="stat"><span data-loc="count">Count:</span> <span id="stat-count"></span></span>
		<span class='pull-right menu-bar'><div class="dropup">
		    <i class="fa fa-question dropdown-toggle" aria-hidden="true" data-toggle="dropdown"></i>
		    <ul class="dropdown-menu dropdown-menu-right">
                <li class='dropdown-header'>How to</li>
		        <li><a href="#" data-toggle='modal' data-target='#help-sell'>Sell multiply items</a></li>
		    </ul>
		  </div></span>
	</div>
	
	<div class="modal fade" id="rename-weapon-modal">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-body"><input type="text" class="form-control" maxlength="20" id='newName'></div>
	            <div class="modal-footer"><button class="btn btn-success" id='renameWeapon'>Rename</button><button class="btn btn-default" data-dismiss='modal'>Cancel</button></div>
	        </div>
	    </div>
	</div>
	
	<div class="modal fade" id="help-sell" data-loc-group='help'>
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <div class="modal-body" data-loc='sell'>
                    <ul>
	                    <li>Go to select mode. Tap and hold on any item.</li>
	                    <li>Now you can select items that you want to sell.</li>
	                    <li>Click on the "Sell selected" button.</li>
                    </ul>
                    <p>Note: locked items won't be sold.</p>
	            </div>
	            <div class="modal-footer"><button class="btn btn-default" data-dismiss='modal'>Cancel</button></div>
	        </div>
	    </div>
	</div>

	<script>
        var Inventory = (function(module) {
            'use strict';
            
            var qualitySort = [
                ".*",
                "consumer",
                "industrial",
                "(milspec|high)",
                "(restricted|remarkable)",
                "(classified|exotic)",
                "(covert|extraordinary)",
                "(rare|contraband)"
            ];
            var weaponsSort = [
                " ",
                ".*USP|P250|Tec|Five|Revolver|Desert|Glock|CZ75|Dual|P2000.*",
                ".*Galil|AK|SG 5|FAMAS|M4A4|M4A1|AUG.*",
                ".*AWP|SSG|G3SG1|SCAR.*",
                ".*MAC|MP7|UMP|PP|P90|MP9.*",
                ".*Nova|XM1|Sawed|MAG.*",
                ".*M249|Negev.*",
                "^★.*(Karambit|Bayonet|Daggers|Knife).*",
                "^★.*(Gloves|Hand Wraps).*"
            ]
            
            module.init = function() {
                $(document).on("click", ".weapon", module.list.click);
                $(document).bind('taphold', module.list.longtap);
                $(document).on('swipeleft swiperight', '.fullWeaponInfo', function(event) {
                    var dir = event.type == 'swipeleft' ? 'next' : 'prev';
                    swipeItem(dir);
                })
                $('ul.inventory').bind('contextmenu', module.list.longtap);
                $('#sellWeapon').on('click', sellItem);
                $('#renameWeapon').on('click', renameWeapon);
                
                $('#apply_sticker').on('click', applySticker);
                $('#apply_sticker_to_item').on('click', applyStickerToItem);
                $(document).on('click', '.remove_sticker', removeSticker);
                $(document).on('click', '#remove_sticker_window', removeSticker);
                $(document).on('click', '#calcel_remove_window', cancelRemoveWindow);
                $(document).on('click', '#scratch_help', scratchHelp);
                $('#cancelSticker').on('click', cancelSticker);
                
                $('#lock').on('click', lockToggle);
                $(".glassBlur, .fullWeaponInfo-close").on("click", function() { hideItem(true) });
                
                $('#startContract').on('click', startContract);
                $('#finishContract').on('click', finishContract);
                $('#cancelContract').on('click', cancelContract);
                
                $("select").change(filterChanged);
                $(document).on('click', '#js-loading-inventory', checkForLoadMore);
                
                $('#unselect').on('click', unselect);
                $('#selectAll').on('click', selectAll);
                $('#sellSelected').on('click', sellSelected);
            }
            
            module.list = {};
            module.list.status = 'default';
            module.list.sticker = {};
            module.list.selectedClass = 'inventoryItemSelected';
            
            module.list.longtap = function(event) {
                if (Inventory.list.status !== 'select') {
                    var $target = $(event.target);
                    var $this = $target.closest('li.weapon');
                    if ($this.length !== 1) return;

                    $this.addClass('inventoryItemSelected');

                    Inventory.list.status = 'select';
                    showSelectBar();
                    event.preventDefault();
                }
            }
            module.list.click = function(event) {
                Sound("selectitems", "play");
                var self = this;
                getItem($(this).data('id')).then(function(item) {
                    if (Inventory.list.status === 'contract') {
                        if (item.souvenir || !item.can.contract)
                            return false;
                        if ($('.inventoryItemSelected').size() < 10 || $(self).hasClass('inventoryItemSelected'))
                            $(self).toggleClass("inventoryItemSelected");
                        if ($('.inventoryItemSelected').size() == 10)
                            $('#finishContract').prop('disabled', false);
                        else
                            $('#finishContract').prop('disabled', true);
                        return false;
                    } else if (Inventory.list.status === 'select') {
                        $(self).toggleClass(Inventory.list.selectedClass);
                        
                        if ($('.'+Inventory.list.selectedClass).length === 0) {
                            Inventory.list.status = 'default';
                            hideSelectBar();
                        }
                        
                        return false;
                    } else if (Inventory.list.status === 'sticker') {
                        if (item.rarity === 'rare' || item.rarity === 'extraordinary' || item.itemType !== 'weapon') {
                            $.notify({
                                message: "Can't apply sticker to this item."
                            }, {
                                type: 'danger'
                            })
                        } else {
                            showItem(item, { sell: false, rename: false, contract: false, applyStickerToItem: true });
                            
                        }
                    } else {
                        showItem(item);
                    }
                })
            }

            // Functions
            function showItem(item, config) {
                var configDefault = {
                    sell: true,
                    rename: true,
                    contract: true,
                    applySticker: true,
                    applyStickerToItem: false
                }
                
                config = $.extend(true, configDefault, config || {});
                
                $(".fullWeaponInfo button").prop("disabled", false);
                $("#weaponInfoContainer").data('id', item.id);
                $("#weaponInfoContainer").data('item', item.saveObject( { id: true } ));

                $("#weaponInfoContainer").css("display", "block");
                $(".fullWeaponInfo").removeClass("info-closed");
                $("#weaponImg").attr("src", item.getImgUrl(true));
                $("#weaponName").html(item.titleText());
                $("#weaponPrice").html(item.price);
                
                // Прячем здесь. В дальнейшем идут проверки на показ
                $('#sellWeapon').hide();
                $('#rename_button').hide();
                $('#startContract').hide();
                $('#apply_sticker_to_item').hide();
                
                if (item.pattern != null) {
                    $('#weaponPhase').parent().show();
                    $('#weaponPhase').text(item.phaseName());
                } else {
                    $('#weaponPhase').parent().hide();
                }

                if (item.itemType == 'weapon') {
                    $("#weaponQuality").parent().show();
                    $("#weaponQuality").html(item.qualityText());
                    $('#weaponRarity').text(item.rarity);
                } else {
                    $("#weaponQuality").parent().hide();
                }
                
                if (item.itemType == 'sticker') {
                    if (config.applySticker) $('#apply_sticker').show();
                } else {
                    $('#apply_sticker').hide();
                }
                
                // Stickers
                if (item.stickers && item.stickers.length > 0) {
                    var stckr = '';
                    item.stickers.forEach(function(sticker, i) {
                        stckr += '<span class="dropup">\
                                      <img data-toggle="dropdown" class="sticker_small" src="' + sticker.getImgUrl() + '">\
                                      <ul class="dropdown-menu' + (i >= 2 ? ' dropdown-menu-right' : '') + '">\
                                        <li class="dropdown-header">' + sticker.titleText() +'\
                                        <li class="divider">\
                                        <li><a href="#" class="remove_sticker" data-index="'+i+'" data-item_id="'+sticker.item_id+'">' + _t('inventory.weapon_info.remove_sticker', "Remove Sticker") + '</a></li>\
                                      </ul></span>'
                    })
                    $('#weaponStickers').show();
                    $('#weaponStickers').html(stckr);
                } else {
                    $('#weaponStickers').hide();
                }

                $('#newName').val(item.getName().replace(/(^"|"$)/g, ''));

                $("#weaponLoadingImg").show();
                $("#weaponImg").hide();
                $("#weaponImg").on('load', function() {
                    $("#weaponLoadingImg").hide();
                    $("#weaponImg").show();
                    if ($('#weaponImg').height() < 360 && $(window).height() > 555) {
                        $('#weaponImg').css('padding', (360 - $('#weaponImg').height()) / 2 + 'px 0')
                    } else {
                        $('#weaponImg').css('padding', '0')
                    }
                })
                
                $('.fullWeaponInfo').removeClass('graffiti sticker');
                
                if (item.itemType === 'sticker') $('.fullWeaponInfo').addClass('sticker');
                if (item.itemType === 'graffiti') $('.fullWeaponInfo').addClass('graffiti');

                $("#statTrakImg").css("display", (item.stattrak ? "block" : "none"));

                if (Player.doubleBalance < 1000) {
                    $('#rename_button').prop('disabled', true);
                } else {
                    $('#rename_button').prop('disabled', false);
                }
                
                if (item.locked) {
                    $('#lock .fa').removeClass('fa-unlock').addClass('fa-lock');
                    $('#sellWeapon').hide();
                    $('#rename_button').hide();
                } else {
                    $('#lock .fa').removeClass('fa-lock').addClass('fa-unlock');
                    
                    if (item.can.sell && config.sell) $('#sellWeapon').show();
                    if (item.can.rename && config.rename) $('#rename_button').show();
                    if (item.can.contract && config.contract)
                        $('#startContract').show();
                    if (item.can.stickers && config.applyStickerToItem) $('#apply_sticker_to_item').show();
                }
            }
            function hideItem(animation) {
                if (animation) {
                    $(".fullWeaponInfo").addClass("info-closed");
                    setTimeout(function() {
                        $("#weaponInfoContainer").css("display", "none");
                    }, 400);
                } else {
                    $("#weaponInfoContainer").css("display", "none");
                }
            }
            function swipeItem(direction) {
                var opened = $('#weaponInfoContainer').data('id');
                
                if (direction == 'prev')
                    var nextWeapon = $('.weapon[data-id='+opened+']').prev('.weapon');
                else
                    var nextWeapon = $('.weapon[data-id='+opened+']').next('.weapon');
                    
                if (nextWeapon.length == 0) return false;
                
                var animElement = $('.fullWeaponInfo');
                
                getItem(nextWeapon.data('id')).then(function(item) {
                    if (direction == 'prev')
                        animElement.css({ left: '100%', opacity: 0});
                    else
                        animElement.css({ left: 0, opacity: 0});
                    setTimeout(function() {
                        hideItem();
                        if (direction == 'prev') {
                            animElement.css({ left: 0, 'transition-duration': '0s' });
                        } else {
                            animElement.css({ left: '100%', 'transition-duration': '0s' });
                        }
                        showItem(item);
                        animElement.removeAttr('style');
                        
                    }, 500)
                    
                })
                
            }
            function openedWeaponInfo() {
                var wp = new Item($("#weaponInfoContainer").data('item'));
                wp.id = $("#weaponInfoContainer").data('item').id;
                return wp;
            }
            function sellItem(item) {
                hideItem(true);
                getItem(openedWeaponInfo().id).then(function(wp) {
                    if (item.itemType == 'weapon' && !PricesBACKUP.checkPrice(wp)) {
                        $.notify({
                            message: 'Price has been modified!'
                        }, {
                            type: 'danger'
                        })
                        LOG.log({
                            action: 'hack',
                            type: 'Change price',
                            item: {
                                id: wp.item_id,
                                name: wp.titleText(),
                                price: wp.price
                            }
                        })
                        return false;
                    }
                    var price = wp.price * 100;
                    if (typeof sellCommis != 'undefined') {
                        price = parseInt((price*(100-sellCommis)/100).toFixed(0));
                    }
                    if (isNaN(price)) {
                        $.notify({
                            message: Localization.getString('inventory.sell_error')
                        }, {
                            type: 'danger'
                        })
                        return false;
                    }
                    deleteWeapon(wp.id);
                    $('[data-id="'+wp.id+'"]').remove();
                    Sound("buy");
                    Player.doubleBalance += price;
                    saveStatistic('doubleBalance', Player.doubleBalance);

                    $('#stat-count').text($('li.weapon').length);

                    LOG.log({
                        action: 'Sell weapon',
                        price: price,
                        balance: Player.doubleBalance
                    })
                    
                    customEvent({ type: 'items', event: 'sell', item_id: wp.item_id })

                    var sum = 0;
                    $('li.weapon').each(function(i, item) {
                        sum += parseFloat($(item).find('i').text());
                    })
                    $('#stat-sum').text(sum.toFixed(2));
                }).catch(function(err) {
                    $.notify({
                        message: 'Can\'t find this item'
                    }, {
                        type: 'danger'
                    })
                })
            }
            function renameWeapon() {
                var newName = $('#newName').val();
                if (newName.length > 20) newName = newName.match(/.{1,20}/g)[0];

                getItem($('#weaponInfoContainer').data('id')).then(function(item) {
                    var lg = {
                        action: 'Rename weapon',
                        old: item.titleText()
                    }
                    if (item.nameTag && newName == '') {
                        item.nameTag = null;
                    } else if (item.name == newName || item.nameOrig == newName) {
                        $('#rename-weapon-modal').modal('hide');
                        return;
                    } else {
                        item.nameTag = newName;
                    }
                    updateItem(item);
                    $('#rename-weapon-modal').modal('hide');

                    $('#weaponName').html(XSSreplace(item.titleText()));
                    $('.weapon[data-id=' + $('#weaponInfoContainer').data('id') + ']').find('.name span').html(XSSreplace(item.getName()));

                    Player.doubleBalance -= 1000;
                    saveStatistic('doubleBalance', Player.doubleBalance);

                    lg.new = item.titleText();
                    LOG.log(lg);
                    customEvent({ type: 'items', event: 'rename', item_id: item.item_id, name: item.nameTag })
                })
            }
            function lockToggle() {
                $(this).find('.fa').toggleClass('fa-lock fa-unlock');
                var wp = openedWeaponInfo();
                wp.locked = $(this).find('.fa').hasClass('fa-lock');
                getItem(wp.id).then(function(item) {
                    item.locked = wp.locked;
                    updateItem(item);
                })
                
                if (wp.locked) {
                    $('#sellWeapon').hide();
                    $('#startContract').hide();
                    $('#rename_button').hide();
                    $('.weapon[data-id=' + wp.id + ']').append('<div class="lock lock-li"><span class="fa fa-lock"></span></div>');
                    
                    customEvent({ type: 'items', event: 'lock', item_id: wp.item_id })
                } else {
                    if (wp.can.sell) $('#sellWeapon').show();
                    if (wp.can.rename) $('#rename_button').show();
                    if (wp.can.contract) $('#startContract').show();
                    $('.weapon[data-id=' + wp.id + '] .lock-li').remove()
                    
                    customEvent({ type: 'items', event: 'unlock', item_id: wp.item_id })
                }
            }
            
            function applySticker() {
                Inventory.list.status = 'sticker';
                Inventory.list.sticker = $("#weaponInfoContainer").data('item');
                hideItem(true);
                $('#applyStickerBar').show();
                $('.inventory').addClass('bottomBar-active');
            }
            function applyStickerToItem() {
                getItem($("#weaponInfoContainer").data('id')).then(function(item) {
                    if (item.addSticker(Inventory.list.sticker.item_id)) {
                        deleteWeapon(Inventory.list.sticker.id);
                        $('.weapon[data-id="' + Inventory.list.sticker.id + '"]').remove();
                        Inventory.list.status = 'default';
                        item.price = item.getPrice();
                        updateOpenedItem(item);
                        $('#applyStickerBar').hide();
                        $('.inventory').removeClass('bottomBar-active');
                        Sound('upgrader.success');
                        
                        LOG.log({
                            action: 'Apply sticker',
                            item_id: item.item_id,
                            itemName: item.titleText(),
                            stickerID: Inventory.list.sticker.item_id,
                            stickerName: new Sticker(Inventory.list.sticker).titleText()
                        })
                        
                        Inventory.list.sticker = {};
                    } else {
                        $.notify({
                            message: "Can't apply sticker to this item."
                        }, {
                            type: 'danger'
                        })
                    }
                })
            }
            function cancelSticker() {
                module.list.status = 'default';
                module.list.sticker = {};
                $("#applyStickerBar").hide();
                $('.inventory').removeClass('bottomBar-active')
            }
            function removeSticker() {
                if (this.className == 'remove_sticker') {
                    var stickerItem_id = $(this).data('item_id');
                    var stickerIndex = $(this).data('index');
                    showScratchWindow(stickerItem_id, stickerIndex);
                    LOG.log({
                        action: 'Open scratch sticker window',
                        stickerID: stickerItem_id
                    })
                } else {
                    $('.stickerScratch').hide();
                    var stickerIndex = $(this).data('index');
                    getItem($("#weaponInfoContainer").data('id')).then(function(item) {
                        LOG.log({
                            action: 'Remove sticker',
                            item_id: item.item_id,
                            stickerID: item.stickers[stickerIndex].item_id
                        })
                        item.stickers.splice(stickerIndex, 1);
                        Sound('interface.sticker_scratch');
                        item.price = item.getPrice();
                        updateOpenedItem(item);
                        
                    })
                }
            }
            function showScratchWindow(stickerID, index) {
                $('.stickerScratch').show();
                $('#remove_sticker_window').data('index', index);
                $('#remove_sticker_window').prop('disabled', true);
                var isDrawing, lastPoint,
                    totalDistance = 0,
                    cleared = false,
                    soundTimeout = 300,
                    soundPlaying = false;
                
                var canvas = document.getElementById("scratch"),
                    ctx = canvas.getContext('2d'),
                    canvasWidth  = canvas.width,
                    canvasHeight = canvas.height;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                var img = new Image;
                img.src = new Sticker(stickerID).getImgUrl(true);
                img.onload = function() {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.drawImage(img, -50, -50);
                }
                var brush = new Image;
                brush.src = 'data:image/png;base64,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';

                // Events
                canvas.addEventListener('mousedown', handleMouseDown, false);
                canvas.addEventListener('touchstart', handleMouseDown, false);
                canvas.addEventListener('mousemove', handleMouseMove, false);
                canvas.addEventListener('touchmove', handleMouseMove, false);
                canvas.addEventListener('mouseup', handleMouseUp, false);
                canvas.addEventListener('touchend', handleMouseUp, false);

                function handleMouseDown(e) {
                    isDrawing = true;
                    lastPoint = getMouse(e, canvas);
                }
                function handleMouseMove(e) {
                    if (!isDrawing || cleared) { return; }

                    e.preventDefault();

                    var currentPoint = getMouse(e, canvas),
                        dist = distanceBetween(lastPoint, currentPoint),
                        angle = angleBetween(lastPoint, currentPoint),
                        x, y;

                    for (var i = 0; i < dist; i++) {
                        x = lastPoint.x + (Math.sin(angle) * i) - 15;
                        y = lastPoint.y + (Math.cos(angle) * i) - 15;
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.drawImage(brush, x, y, 30, 30);
                    }
                    
                    totalDistance += dist;
                    console.log(totalDistance);
                    
                    if (!soundPlaying) {
                        var soundNum = Math.rand(1, 5);
                        Sound('scratch.' + soundNum);
                        soundPlaying = true;
                        setTimeout(function() { soundPlaying = false; }, soundTimeout);
                    }
                    
                    if (totalDistance > 3000) {
                        cleared = true;
                        console.log("Cleared!");
                        $('#remove_sticker_window').prop('disabled', false);
                        
                        canvas.removeEventListener('mousedown', handleMouseDown, false);
                        canvas.removeEventListener('touchstart', handleMouseDown, false);
                        canvas.removeEventListener('mousemove', handleMouseMove, false);
                        canvas.removeEventListener('touchmove', handleMouseMove, false);
                        canvas.removeEventListener('mouseup', handleMouseUp, false);
                        canvas.removeEventListener('touchend', handleMouseUp, false);
                    }

                    lastPoint = currentPoint;
                }
                function handleMouseUp(e) {
                    isDrawing = false;
                }
                
                // Utils
                function distanceBetween(point1, point2) {
                    return Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
                }

                function angleBetween(point1, point2) {
                    return Math.atan2( point2.x - point1.x, point2.y - point1.y );
                }

                function getMouse(e, canvas) {
                    var offsetX = 0, offsetY = 0, mx, my;
                    /*
                    if (canvas.offsetParent !== undefined) {
                        do {
                            offsetX += canvas.offsetLeft;
                            offsetY += canvas.offsetTop;
                        } while ((canvas = canvas.offsetParent));
                    }

                    mx = (e.pageX || e.touches[0].clientX) - offsetX;
                    my = (e.pageY || e.touches[0].clientY) - offsetY;
                    */
                    var rect = canvas.getBoundingClientRect();
                    mx = (e.clientX || e.touches[0].clientX) - rect.left;
                    my = (e.clientY || e.touches[0].clientY) - rect.top;

                    return {x: mx, y: my};
                }
            }
            function cancelRemoveWindow() {
                $('.stickerScratch').hide();
            }
            function scratchHelp() {
                if ($('#scratchFinger').length) return false;
                
                var finger = new Image;
                finger.src = "data:image/svg+xml;base64,CjxzdmcgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDEwMDAgMTAwMCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAwMCAxMDAwIiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPG1ldGFkYXRhPiBTdmcgVmVjdG9yIEljb25zIDogaHR0cDovL3d3dy5vbmxpbmV3ZWJmb250cy5jb20vaWNvbiA8L21ldGFkYXRhPgogIDxnPjxwYXRoIGQ9Ik00MDQuOCw2NTcuNWMtNy45LDAtMTQuMy02LjQtMTQuMy0xNC4zVjI2Mi4zYzAtMzQuMSwyNy44LTYxLjksNjEuOS02MS45czYxLjksMjcuOCw2MS45LDYxLjl2MzMzLjNjMCw3LjktNi40LDE0LjMtMTQuMywxNC4zYy03LjksMC0xNC4zLTYuNC0xNC4zLTE0LjNWMjYyLjNjMC0xOC40LTE1LTMzLjMtMzMuMy0zMy4zYy0xOC40LDAtMzMuMywxNS0zMy4zLDMzLjN2MzgwLjlDNDE5LjEsNjUxLjEsNDEyLjcsNjU3LjUsNDA0LjgsNjU3LjV6IiBzdHlsZT0iZmlsbDojMDBiYjljIj48L3BhdGg+PHBhdGggZD0iTTU5NS4yLDYwOS45Yy03LjksMC0xNC4zLTYuNC0xNC4zLTE0LjNWNDA1LjJjMC0xOC40LTE1LTMzLjMtMzMuMy0zMy4zYy0xOC40LDAtMzMuMywxNS0zMy4zLDMzLjN2MTkwLjRjMCw3LjktNi40LDE0LjMtMTQuMywxNC4zYy03LjksMC0xNC4zLTYuNC0xNC4zLTE0LjNWNDA1LjJjMC0zNC4xLDI3LjgtNjEuOSw2MS45LTYxLjljMzQuMSwwLDYxLjksMjcuOCw2MS45LDYxLjl2MTkwLjRDNjA5LjUsNjAzLjUsNjAzLjEsNjA5LjksNTk1LjIsNjA5Ljl6IiBzdHlsZT0iZmlsbDojMDBiYjljIj48L3BhdGg+PHBhdGggZD0iTTY5MC40LDYwOS45Yy03LjksMC0xNC4zLTYuNC0xNC4zLTE0LjNWNDUyLjhjMC0xOC40LTE1LTMzLjMtMzMuMy0zMy4zYy0xOC40LDAtMzMuMywxNS0zMy4zLDMzLjN2MTQyLjhjMCw3LjktNi40LDE0LjMtMTQuMywxNC4zYy03LjksMC0xNC4zLTYuNC0xNC4zLTE0LjNWNDUyLjhjMC0zNC4xLDI3LjgtNjEuOSw2MS45LTYxLjljMzQuMSwwLDYxLjksMjcuOCw2MS45LDYxLjl2MTQyLjhDNzA0LjcsNjAzLjUsNjk4LjMsNjA5LjksNjkwLjQsNjA5Ljl6IiBzdHlsZT0iZmlsbDojMDBiYjljIj48L3BhdGg+PHBhdGggZD0iTTU5NS4yLDk5MGMtNjEuMywwLTExOC44LTI3LjEtMTU3LjktNzQuNEwyMjMuNCw2MzkuM2MtMTAuNi05LTE3LjktMjQuMS0xOS00MC42Yy0xLTE2LjUsNC41LTMyLjQsMTUuNC00NC44YzEwLjktMTIuNCwyNi4xLTE5LjgsNDIuNi0yMC44YzE2LjQtMC45LDMyLjQsNC40LDQ0LjgsMTUuNGwxMDYuMyw4Mi44YzYuMiw0LjksNy4zLDEzLjgsMi41LDIwYy00LjksNi4yLTEzLjksNy4zLTIwLDIuNWwtMTA3LTgzLjNjLTcuMy02LjUtMTYuMS05LjUtMjQuOC04LjhjLTguOSwwLjUtMTcsNC41LTIyLjksMTEuMmMtMTIuMiwxMy44LTEwLjksMzQuOSwyLjksNDcuMWwyMTUuNSwyNzhjMzMuMyw0MC4zLDgyLjgsNjMuNywxMzUuNiw2My43Yzk3LjEsMCwxNzYuMi03OSwxNzYuMi0xNzYuMlY0OTkuNmMwLTE4LjQtMTUtMzMuMy0zMy4zLTMzLjNjLTE4LjQsMC0zMy4zLDE1LTMzLjMsMzMuM3Y5NS4yYzAsNy45LTYuNCwxNC4zLTE0LjMsMTQuM3MtMTQuMy02LjQtMTQuMy0xNC4zdi05NS4yYzAtMzQuMSwyNy44LTYxLjksNjEuOS02MS45czYxLjksMjcuOCw2MS45LDYxLjl2Mjg1LjdDNzk5LjksODk4LjIsNzA4LjEsOTkwLDU5NS4yLDk5MHoiIHN0eWxlPSJmaWxsOiMwMGJiOWMiPjwvcGF0aD48cGF0aCBkPSJNNTk1LjIsMjc2LjZjLTcuOSwwLTE0LjMtNi40LTE0LjMtMTQuM2MwLTcwLjktNTcuNy0xMjguNi0xMjguNi0xMjguNmMtNzAuOSwwLTEyOC42LDU3LjctMTI4LjYsMTI4LjZjMCw3LjktNi40LDE0LjMtMTQuMywxNC4zYy03LjksMC0xNC4zLTYuNC0xNC4zLTE0LjNjMC04Ni42LDcwLjUtMTU3LjEsMTU3LjEtMTU3LjFjODYuNiwwLDE1Ny4xLDcwLjUsMTU3LjEsMTU3LjFDNjA5LjUsMjcwLjIsNjAzLjEsMjc2LjYsNTk1LjIsMjc2LjZ6IiBzdHlsZT0iZmlsbDojMDBiYjljIj48L3BhdGg+PHBhdGggZD0iTTY5MC40LDI3Ni42Yy03LjksMC0xNC4zLTYuNC0xNC4zLTE0LjNjMC0xMjMuNC0xMDAuNC0yMjMuOC0yMjMuOC0yMjMuOGMtMTIzLjQsMC0yMjMuOCwxMDAuNC0yMjMuOCwyMjMuOGMwLDcuOS02LjQsMTQuMy0xNC4zLDE0LjNjLTcuOSwwLTE0LjMtNi40LTE0LjMtMTQuM0MyMDAuMSwxMjMuMiwzMTMuMywxMCw0NTIuNCwxMGMxMzkuMSwwLDI1Mi4zLDExMy4yLDI1Mi4zLDI1Mi4zQzcwNC43LDI3MC4yLDY5OC4zLDI3Ni42LDY5MC40LDI3Ni42eiIgc3R5bGU9ImZpbGw6IzAwYmI5YyI+PC9wYXRoPjwvZz48L3N2Zz4KICA=";
                finger.width = 64;
                finger.height = 64;
                finger.setAttribute('id', 'scratchFinger');
                finger.style = 'position: fixed; top: 50px; left: 50px';
                
                $('.stickerScratch').append(finger);
                $('#scratchFinger').animate({
                    left: 230,
                    top: 100
                }, 500)
                $('#scratchFinger').animate({
                    left: 50,
                    top: 200
                }, 500)
                $('#scratchFinger').animate({
                    left: 230,
                    top: 300
                }, 500, function() {
                    $('#scratchFinger').remove();
                    
                })
            }
            
            function startContract() {
                var rarity = $('#weaponRarity').text();
                var statTrak = ($('#statTrakImg').css('display') == 'block') ? true : false;

                for (var i = 1; i < qualitySort.length; i++) {
                    if (RegExp(qualitySort[i]).test(rarity))
                        $('#sort-quality :nth-child(' + (i + 1) + ')').prop('selected', 'true').change();
                }
                var spec = (statTrak ? 3 : 7);
                $('#sort-special :nth-child(' + spec + ')').prop('selected', 'true').change();

                hideItem(true);
                $('#tradeBar').css('display', 'block');
                $('#finishContract').prop('disabled', true);
                $('.inventoryList').css('padding-bottom', '65px');
                $('#sort-special').prop('disabled', true);
                $('#sort-quality').prop('disabled', true);
                Inventory.list.status = 'contract';

                setTimeout(function(){
                    $('li[data-id="' + $("#weaponInfoContainer").data('id') + '"]').addClass(Inventory.list.selectedClass);
                }, 500);
            }
            function finishContract() {
                var rnd = $('.'+Inventory.list.selectedClass)[Math.rand(0, 9)];
                getWeapon($(rnd).data('id')).then(function(weapon) {
                    if (weapon.collection() != -1) {
                        var nextRarity = "";
                        for (var i = qualitySort.length - 1; i > 0; --i) {
                            if (new RegExp(qualitySort[i]).test(weapon.rarity) && i + 1 < qualitySort.length - 1) {
                                nextRarity = qualitySort[i+1];
                                break;
                            }
                        }

                        if (nextRarity == '')
                            return false;

                        var nextRarityWeapons = [];
                        var collectionWeapons = getWeaponsById(weapon.collection().weapons);

                        for (var i = 0; i < collectionWeapons.length; i++)
                            if (new RegExp(nextRarity).test(collectionWeapons[i].rarity))
                                nextRarityWeapons.push(collectionWeapons[i]);
                        var newWeapon = nextRarityWeapons[Math.rand(0, nextRarityWeapons.length - 1)];
                    }

                    if (typeof newWeapon == 'undefined') {
                        $.notify({
                            message: Localization.getString('inventory.trade_up_contract.contract_error.message')
                        }, {
                            type: 'danger'
                        })
                        return false;
                    }

                    newWeapon.quality = weapon.quality;
                    newWeapon.stattrak = weapon.stattrak;
                    newWeapon.item_id = newWeapon.id;

                    newWeapon = new Item(newWeapon);

                    if (newWeapon.price == 0)
                        newWeapon.qualityRandom();

                    newWeapon.new = true;

                    $("."+Inventory.list.selectedClass).each(function() {
                        deleteWeapon(parseInt($(this).data('id')));
                    })

                    saveWeapon(newWeapon).then(function(result) {
                        newWeapon.id = result;
                        showItem(newWeapon);
                    });

                    statisticPlusOne('contracts');
                    Sound("contract", "play");
                    $('#cancelContract').click();
                    
                    customEvent({ type: 'items', event: 'contract', item_id: newWeapon.item_id })
                })
            }
            function cancelContract() {
                $('#tradeBar').css('display', 'none');
                $('#sort-special :nth-child(1)').prop('selected', 'true').change();
                $('#sort-quality :nth-child(1)').prop('selected', 'true').change();
                $('#sort-weapon :nth-child(1)').prop('selected', 'true').change();
                $('.inventoryList').css('padding-bottom', '15px');

                $('#sort-special').removeAttr('disabled');
                $('#sort-quality').removeAttr('disabled');

                Inventory.list.status = 'default';
            }
            
            function fillInventory(currInventory, sumPr, count) {
                var wp_from = parseInt($('#js-loading-inventory').data('from'));
                $('#js-loading-inventory').remove();
                if (!Array.isArray(currInventory)) return false;

                //var ticker_limit = window.innerWidth <= 433 ? 16 : 20;

                for (var i = 0; i < currInventory.length; i++) {
                    var weapon = currInventory[i];
                    var img = getImgUrl(weapon.img);

                    var weaponInfo = weapon.toLi({price: true, nameTag: true, new: true, locked: true});

                    $(".inventory").append(weaponInfo);

                    if (weapon.new == true) {
                        currInventory[i].new = false;
                        updateItem(currInventory[i]);
                    }
                }

                $("#stat-sum").html(sumPr.toFixed(2));
                $("#stat-count").html(count);
                inventory_loading = false;

                if (currInventory.length == 0) {
                    $(".inventory").append("<li id='empty-inventory'>" + Localization.getString('other.empty_inventory') + "</li>");
                    return false;
                }
                if ((wp_from + inventory_step) < count) {
                    $('.inventory').append('<li id="js-loading-inventory" data-from="' + (wp_from + inventory_step) + '"><div class="cssload-container"><div class="cssload-speeding-wheel"></div></div></li>');

                    if($(window).scrollTop() + $(window).height() >= $(document).height() - 80)
                        checkForLoadMore();
                }
            }
            function checkForLoadMore() {
                if ($(window).scrollTop() + $(window).height() > $(document).height() - 80 && $('#js-loading-inventory').length) {
                    var wp_from = parseInt($('#js-loading-inventory').data('from'));
                    if (isNaN(wp_from)) wp_from = 1;
                    if (!inventory_loading)
                        loadMore(wp_from);
                }
            }
            function loadMore(wp_from) {
                inventory_loading = true;

                getInventory(wp_from, wp_from + inventory_step - 1, {loadMore: true}).then(function(result) {
                    Inventory.fillInventory(result.weapons, result.worth, result.count);
                });
            }
            function filterChanged() {
                var special = $("#sort-special :selected").val();
                var weapon = $("#sort-weapon :selected").val();
                var quality = $("#sort-quality :selected").val();

                var wp_from = parseInt($("#js-loading-inventory").data('from'));
                
                var sortedInventory = {};

                $(document.body).scrollTop(0);
                getInventory().then(function(result) {
                    var inventory = result.weapons;
                    switch (parseInt(special)) {
                        case 0:
                            sortedInventory = inventory;
                            break
                        case 1:
                            sortedInventory = sortInventory(inventory, "new", true);
                            break
                        case 2:
                            sortedInventory = sortInventory(inventory, "stattrak", true);
                            break
                        case 3:
                            sortedInventory = sortInventory(inventory, "stattrak", false);
                            break
                        case 4:
                            sortedInventory = sortInventory(inventory, "souvenir", true);
                            break
                        case 5:
                            sortedInventory = sortInventory(inventory, "souvenir", false);
                            break
                        case 6:
                            sortedInventory = sortInventory(inventory, "souvenir", false);
                            sortedInventory = sortInventory(sortedInventory, "stattrak", false);
                            break
                        case 7:
                            sortedInventory = sortInventory(inventory, "itemType", 'graffiti');
                            break
                        case 8:
                            sortedInventory = sortInventory(inventory, "itemType", 'sticker');
                            break
                        default:
                            sortedInventory = inventory
                            break
                    }
                    if (parseInt(weapon) != 0) {
                        sortedInventory = sortInventory(sortedInventory, "type", RegExp(weaponsSort[parseInt(weapon)]))
                    }
                    if (parseInt(quality) != 0) {
                        sortedInventory = sortInventory(sortedInventory, "rarity", RegExp(qualitySort[parseInt(quality)]))
                    }
                    INVENTORY.weapons = sortedInventory;
                    INVENTORY.count = sortedInventory.length;
                    INVENTORY.worth = sortedInventory.reduce(function(sum, cur) {
                        return sum + cur.price;
                    }, 0)

                    if (sortedInventory.length > 50)
                        sortedInventory = sortedInventory.slice(0, 50);
                    return {
                        weapons: sortedInventory,
                        count: INVENTORY.count,
                        worth: INVENTORY.worth
                    }
                }).then(function(result) {
                    $(".inventory li").remove();
                    $('.inventory').append('<li id="js-loading-inventory" data-from="1"><div class="cssload-container"><div class="cssload-speeding-wheel"></div></div></li>');
                    return fillInventory(result.weapons, result.worth, result.count);
                }).then(function() {
                    if ($('#empty-inventory').length > 0)
                        $("#empty-inventory").remove();
                })
            }
            function sortInventory(currInventory, attr, value) {
                var sorted = [];
                for (var i = 0; i < currInventory.length; i++) {
                    if (value.constructor != RegExp) {
                        if (currInventory[i][attr] == value)
                            sorted.push(currInventory[i]);
                    } else {
                        if (value.test(currInventory[i][attr])) {
                            sorted.push(currInventory[i]);
                        }
                    }
                }
                return sorted;
            }
            
            function showSelectBar() {
                $('#selectBar').show();
            }
            function hideSelectBar() {
                $('#selectBar').hide();
            }
            function unselect() {
                $('.'+Inventory.list.selectedClass).removeClass(Inventory.list.selectedClass);
                
                module.list.status = 'default';
                hideSelectBar();
            }
            function selectAll() {
                $('li.weapon:not(.'+Inventory.list.selectedClass+')').addClass(Inventory.list.selectedClass);
            }
            function sellSelected() {
                $('#selectBar > *').prop('disabled', true);
                var selectedID = [];
                $('.' + Inventory.list.selectedClass).each(function(i, item) {
                    selectedID.push($(item).data('id'));
                })
                
                getItems(selectedID).then(function(items) {
                    var cancelSell = false;
                    items.forEach(function(wp, i) {
                        if (!wp.can.sell) {
                            selectedID[i] = null;
                            weapons[i] = null;
                        }
                        if (wp.itemType == 'weapon' && !PricesBACKUP.checkPrice(wp)) {
                            $.notify({
                                message: 'Price has been modified!'
                            }, {
                                type: 'danger'
                            })
                            LOG.log({
                                action: 'hack',
                                type: 'Change price',
                                item: {
                                    id: wp.item_id,
                                    name: wp.titleText(),
                                    price: wp.price
                                }
                            })
                            cancelSell = true;
                        }
                        
                        customEvent({ type: 'items', event: 'sell', item_id: wp.item_id })
                    })
                    if (cancelSell) {
                        $('#selectBar > *').prop('disabled', false);
                        return false;
                    }
                    
                    var totalPrice = items.reduce(function(sum, curr) {
                        if (curr)
                            return sum + curr.price;
                        else
                            return sum
                    }, 0) * 100;
                    
                    if (typeof sellCommis != 'undefined') {
                        totalPrice = parseInt((totalPrice*(100-sellCommis)/100).toFixed(0));
                    }
                    
                    selectedID.forEach(function(id) {
                        if (id) {
                            deleteWeapon(id);
                            $('[data-id="'+id+'"]').remove();
                        }
                    })
                    
                    Player.doubleBalance += totalPrice;
                    saveStatistic('doubleBalance', Player.doubleBalance);
                    
                    Sound("buy");
                    
                    $('#selectBar > *').prop('disabled', false);
                    unselect();
                })
            }
            
            // Utils
            function updateOpenedItem(item) {
                updateItem(item);
                hideItem();
                showItem(item);
                $('.weapon[data-id="' + item.id + '"]').replaceWith(item.toLi({price: true, nameTag: true, new: true, locked: true}));
            }
            
            module.fillInventory = fillInventory;
            module.checkForLoadMore = checkForLoadMore;
            module.swipeItem = swipeItem;
            return module;
        })(Inventory || {});

        $(function() {
            Inventory.init();
        })

		$(document).on('localizationloaded', function() {
			getInventory(1, 50)
            .then(function(result) {
                Inventory.fillInventory(result.weapons, result.worth, result.count);
            })
		});

		$(window).scroll(function() {
			Inventory.checkForLoadMore();
		});

        $(document).on('localizationloaded', function() {
            var sortSpecial = Localization.getString('inventory.sort.special');
            var sortWeapon = Localization.getString('inventory.sort.types');
            var sortQuality = Localization.getString('inventory.sort.quality');

            $('#sort-special').prop('disabled', false);
            $('#sort-quality').prop('disabled', false);

            for (var i = 0; i < sortSpecial.length; i++) {
                $("#sort-special").append("<option value='" + i + "'>" + sortSpecial[i] + "</option>");
            }
            for (var i = 0; i < sortWeapon.length; i++) {
                $("#sort-weapon").append("<option value='" + i + "'>" + sortWeapon[i] + "</option>");
            }
            for (var i = 0; i < sortQuality.length; i++) {
                $("#sort-quality").append("<option value='" + i + "'>" + sortQuality[i] + "</option>");
            }
        })
	</script>
</body>
</html>
